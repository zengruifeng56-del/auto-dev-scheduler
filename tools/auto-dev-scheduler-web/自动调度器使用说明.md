# Auto-Dev Scheduler 使用说明

Auto-Dev Scheduler 是一个基于 Electron + Vue 3 的桌面应用，用于调度和管理多个 Claude CLI Worker 并发执行 AUTO-DEV.md 中定义的开发任务。

## 目录

- [技术栈](#技术栈)
- [安装与运行](#安装与运行)
- [项目结构](#项目结构)
- [核心概念](#核心概念)
- [使用流程](#使用流程)
- [架构说明](#架构说明)
- [开发指南](#开发指南)

---

## 技术栈

| 层级 | 技术 |
|------|------|
| 桌面框架 | Electron 28 |
| 前端框架 | Vue 3.4 + TypeScript |
| 状态管理 | Pinia |
| UI 组件库 | Element Plus |
| 进程管理 | tree-kill |
| 构建工具 | Vite 5 |

---

## 安装与运行

```bash
cd tools/auto-dev-scheduler-web

# 安装依赖
npm install

# 开发模式
npm run dev

# 类型检查
npm run typecheck

# 构建
npm run build

# 打包 Windows 安装程序
npm run build:win
```

---

## 项目结构

```
auto-dev-scheduler-web/
├── src/
│   ├── main/                       # Electron 主进程
│   │   ├── index.ts               # 主进程入口，窗口创建，Scheduler/Watchdog 初始化
│   │   ├── scheduler-service.ts   # 核心调度器服务
│   │   ├── claude-worker.ts       # Claude CLI Worker 封装
│   │   ├── parser.ts              # AUTO-DEV.md 解析器
│   │   ├── watchdog.ts            # Worker 健康监控
│   │   ├── log-manager.ts         # 任务日志管理
│   │   ├── delivery-check.ts      # 交付检查
│   │   └── ipc-handlers.ts        # IPC 处理器
│   │
│   ├── preload/
│   │   └── index.ts               # 预加载脚本，暴露 Electron API
│   │
│   ├── renderer/                  # Vue 渲染进程
│   │   ├── components/
│   │   │   ├── ControlBar.vue     # 控制栏（加载/启动/暂停/停止）
│   │   │   ├── StatusBar.vue      # 状态栏（进度/文件路径）
│   │   │   ├── TaskTable.vue      # 任务列表表格
│   │   │   ├── LogPanel.vue       # Worker 日志面板
│   │   │   └── SettingsDialog.vue # Watchdog 设置对话框
│   │   │
│   │   ├── stores/
│   │   │   └── scheduler.ts       # 调度器状态管理
│   │   │
│   │   ├── App.vue                # 根组件
│   │   └── main.ts                # 渲染进程入口
│   │
│   └── shared/
│       ├── ipc-channels.ts        # IPC 通道常量
│       ├── types.ts               # 共享类型定义
│       └── electron-api.d.ts      # Electron API 类型声明
│
├── index.html
├── vite.config.ts
├── package.json
└── tsconfig.*.json
```

---

## 核心概念

### 1. AUTO-DEV.md 文件格式

调度器解析 `openspec/execution/{project}/AUTO-DEV.md` 文件中的任务定义：

```markdown
## Wave 1: task-01, task-02

### task-01: 任务标题
- [ ] **未认领**
- **依赖**: 无
- **预估上下文**: ~15k tokens

### task-02: 另一个任务
- [x] **已完成**
- **依赖**: task-01
```

#### 任务状态标记

| 标记 | 状态 | 说明 |
|------|------|------|
| `- [ ]` | `ready` | 可执行（依赖已满足） |
| `- [~]` | `running` | 执行中 |
| `- [x]` | `success` | 已完成 |
| `- [!]` | `pending` | 阻塞（依赖未满足） |

#### 状态字段（可选）

```markdown
**状态**: 未认领 / 执行中 / 已完成 / 失败
```

### 2. Wave（波次）

- 同一 Wave 内的任务可以并行执行
- 不同 Wave 按顺序执行
- 任务依赖关系跨 Wave 自动处理

### 3. Worker

- 每个 Worker 是一个独立的 Claude CLI 进程
- 最多支持 4 个并发 Worker
- Worker 自动认领 `ready` 状态的任务

### 4. Watchdog（健康监控）

双层诊断机制：

| 层级 | 说明 |
|------|------|
| Layer 1 | 规则诊断：进程存活检测、日志错误匹配、工具调用超时 |
| Layer 2 | AI 诊断：调用 Claude 分析日志，决定重启/等待/人工介入 |

#### 诊断规则

| 规则 | 条件 | 动作 |
|------|------|------|
| Rule 1 | 进程不存在或已退出 | 重启 |
| Rule 2 | 日志出现明确错误（504/timeout/ECONNRESET） | 重启 |
| Rule 3 | 慢操作工具调用超时（codex/gemini/npm） | 重启 |
| Rule 4 | 普通工具调用超时 | 重启 |
| AI | 规则无法判断时 | AI 诊断决策 |

---

## 使用流程

### 1. 加载 AUTO-DEV.md 文件

1. 点击 **选择文件** 按钮
2. 选择项目中的 `openspec/execution/{project}/AUTO-DEV.md`
3. 解析后任务列表显示在表格中

### 2. 启动调度

1. 设置 **并发数**（1-4）
2. 点击 **启动** 按钮
3. 调度器自动：
   - 查找 `ready` 状态且依赖已满足的任务
   - 启动 Claude CLI Worker
   - 发送 `/auto-dev --task {taskId}` 命令

### 3. 监控执行

- **任务表格**: 实时显示任务状态、耗时、分配的 Worker
- **日志面板**: 显示每个 Worker 的实时输出
- **状态栏**: 显示整体进度 (completed/total)

### 4. 控制操作

| 操作 | 说明 |
|------|------|
| 暂停 | 不分配新任务，已运行任务继续 |
| 恢复 | 继续分配新任务 |
| 停止 | 终止所有 Worker，停止调度 |
| Kill Worker | 终止指定 Worker |

### 5. 交付检查

所有任务完成后，自动进行交付检查：
- 解析 `tasks.md` 中的检查清单
- 对比 AUTO-DEV.md 中的完成状态
- 生成覆盖率报告

---

## 架构说明

### 整体架构

```
┌──────────────────────────────────────────────────────────────────┐
│                       Electron Main Process                       │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐ │
│  │   Scheduler   │  │   Watchdog    │  │     Log Manager       │ │
│  │  (调度核心)    │  │  (健康监控)   │  │    (日志管理)         │ │
│  └───────┬───────┘  └───────┬───────┘  └───────────────────────┘ │
│          │                  │                                     │
│          ▼                  ▼                                     │
│  ┌───────────────────────────────────────┐                       │
│  │         Claude Worker × N             │                       │
│  │  (Claude CLI 子进程, 最多 4 个)        │                       │
│  └───────────────────────────────────────┘                       │
└──────────────────────────────────────────────────────────────────┘
                              │ IPC
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                    Electron Renderer Process                      │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────────────┐ │
│  │  ControlBar  │  │  TaskTable   │  │       LogPanel          │ │
│  └──────────────┘  └──────────────┘  └─────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

### 调度流程

```
1. loadFile(path)
   └── 解析 AUTO-DEV.md → tasks Map + waveMap

2. start(maxParallel)
   └── 启动 tick 定时器（每 5 秒）

3. tick()
   ├── 重新解析 AUTO-DEV.md（检测外部修改）
   ├── 同步任务状态
   ├── 检测超时 Worker
   ├── 恢复僵死任务
   └── 启动新 Worker（如有空闲槽位）

4. spawnWorker(workerId, taskId)
   ├── 创建 ClaudeWorker 实例
   ├── 执行 claude CLI 命令
   ├── 发送 /auto-dev --task {taskId}
   └── 监听 log/complete/error 事件

5. 任务完成
   ├── 重新解析文件确认状态
   ├── 更新任务状态
   └── 触发下一轮 tick
```

### IPC 通道

| 通道 | 方向 | 说明 |
|------|------|------|
| `scheduler:loadFile` | R→M | 加载 AUTO-DEV.md |
| `scheduler:start` | R→M | 启动调度 |
| `scheduler:pause` | R→M | 暂停调度 |
| `scheduler:resume` | R→M | 恢复调度 |
| `scheduler:stop` | R→M | 停止调度 |
| `worker:send` | R→M | 向 Worker 发送消息 |
| `worker:kill` | R→M | 终止 Worker |
| `scheduler:fullState` | M→R | 完整状态推送 |
| `scheduler:taskUpdate` | M→R | 任务状态更新 |
| `scheduler:workerLog` | M→R | Worker 日志推送 |
| `scheduler:progress` | M→R | 进度更新 |
| `worker:healthWarning` | M→R | Worker 健康告警 |

### 状态类型

```typescript
interface Task {
  id: string;          // 任务 ID
  title: string;       // 任务标题
  status: TaskStatus;  // pending | ready | running | success | failed
  wave: number;        // 波次
  dependencies: string[];
  estimatedTokens?: number;
  duration?: number;   // 执行时长（秒）
  startTime?: string;
  endTime?: string;
  workerId?: number;   // 分配的 Worker ID
}

interface WorkerState {
  id: number;
  active: boolean;
  taskId?: string;
  tokenUsage?: string;  // "10.2k"
  currentTool?: string; // 当前执行的工具
  logs: LogEntry[];
}
```

---

## 开发指南

### 关键文件定位

| 功能 | 文件 |
|------|------|
| 调度核心逻辑 | `src/main/scheduler-service.ts` |
| Claude CLI 封装 | `src/main/claude-worker.ts` |
| AUTO-DEV.md 解析 | `src/main/parser.ts` |
| 健康监控 | `src/main/watchdog.ts` |
| 日志管理 | `src/main/log-manager.ts` |
| 交付检查 | `src/main/delivery-check.ts` |
| 前端状态 | `src/renderer/stores/scheduler.ts` |

### 修改任务解析规则

编辑 `src/main/parser.ts`:

```typescript
// 添加新的状态映射
function mapStatus(raw: string | undefined): TaskStatus {
  // ... 添加新的匹配规则
}

// 修改任务提取正则
const taskHeaderPattern = /^###\s+([\w.-]+)\s*[：:]\s*(.+)$/gim;
```

### 修改 Watchdog 规则

编辑 `src/main/watchdog.ts`:

```typescript
// 添加错误匹配模式
private findClearError(logTail: string): string | null {
  const patterns: RegExp[] = [
    /\b504\b/i,
    /\btimeout\b/i,
    // 添加新模式
  ];
}

// 修改工具超时配置
const DEFAULT_WATCHDOG_CONFIG: WatchdogConfig = {
  slowToolTimeouts: {
    codex: 60 * 60_000,    // 60 分钟
    gemini: 60 * 60_000,
    npmInstall: 15 * 60_000,
    npmBuild: 20 * 60_000,
    default: 10 * 60_000
  }
};
```

### 添加新的 IPC 命令

1. **定义通道** (`src/shared/ipc-channels.ts`)
   ```typescript
   export const IPC_CHANNELS = {
     // 添加新通道
     MY_NEW_COMMAND: 'my:newCommand',
   };
   ```

2. **实现处理器** (`src/main/ipc-handlers.ts`)
   ```typescript
   ipcMain.handle(IPC_CHANNELS.MY_NEW_COMMAND, async (_event, args) => {
     // 处理逻辑
   });
   ```

3. **暴露 API** (`src/preload/index.ts`)
   ```typescript
   myNewCommand: (args: T) => ipcRenderer.invoke(IPC_CHANNELS.MY_NEW_COMMAND, args),
   ```

4. **前端调用** (`src/renderer/stores/scheduler.ts`)
   ```typescript
   async myNewCommand(args: T) {
     return window.electronAPI.myNewCommand(args);
   }
   ```

### Watchdog 配置调整

通过设置对话框或直接修改默认配置：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `checkIntervalMs` | 健康检查间隔 | 5 分钟 |
| `activityTimeoutMs` | 无活动超时阈值 | 10 分钟 |
| `slowToolTimeouts.codex` | Codex 调用超时 | 60 分钟 |
| `slowToolTimeouts.gemini` | Gemini 调用超时 | 60 分钟 |
| `slowToolTimeouts.npmInstall` | npm install 超时 | 15 分钟 |
| `slowToolTimeouts.npmBuild` | npm build 超时 | 20 分钟 |
| `slowToolTimeouts.default` | 其他工具超时 | 10 分钟 |

---

## 日志与恢复

### 任务日志位置

```
{userData}/logs/{taskId}/
├── run-{timestamp}.log      # 执行日志
└── checkpoint.json          # 检查点（已完成步骤）
```

### 恢复机制

当任务被中断后重新执行时：
1. 读取上次的 checkpoint
2. 向 Worker 注入恢复提示
3. Claude 从上次中断点继续

### 清除任务日志

```typescript
// 通过 IPC 调用
await window.electronAPI.clearTaskLogs(taskId);
```

---

## 常见问题

### Worker 启动失败

- 检查 `claude` CLI 是否在 PATH 中
- 确认 `--dangerously-skip-permissions` 参数可用

### 任务状态不同步

- 调度器每 5 秒重新解析 AUTO-DEV.md
- 外部修改文件后状态会自动同步

### Watchdog 误杀

- 调整 `slowToolTimeouts` 增加慢操作容忍时间
- 检查日志确认是否为误判
